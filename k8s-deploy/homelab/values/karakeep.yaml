#
# IMPORTANT NOTE
#
# This chart inherits from the bjw-s library chart. You can check the default values/options here:
# https://github.com/bjw-s/helm-charts/tree/main/charts/library/common
#

applicationProtocol: http
applicationHost: karakeep.prod.phuchoang.sbs
applicationSecretKey: JGB7K1ewXhiBpJF6cTuRbGljRXsw2TA0mREoO9BCvE3x563k
meilisearchMasterKey: hQA6bWauvsskfBN/6OQPA2fQZ/MEtX1lF85LHxbzNWyyXI3Q

controllers:
  karakeep:
    type: statefulset

    containers:
      karakeep:
        image:
          repository: ghcr.io/karakeep-app/karakeep
          tag: "0.27.0"

        env:
          NEXTAUTH_URL: "{{ .Values.applicationProtocol }}://{{ .Values.applicationHost }}"

          DATA_DIR: /data
          MEILI_ADDR: "http://{{ .Release.Name }}-meilisearch:7700"
          BROWSER_WEB_URL: http://{{ .Release.Name }}-chrome:9222

        envFrom:
          - secretRef:
              name: "{{ .Release.Name }}"
          - secretRef:
              name: "{{ .Release.Name }}-meilesearch"

        probes:
          liveness:
            enabled: true
            spec:
              initialDelaySeconds: 10
              httpGet:
                path: /api/health
                port: 3000
          readiness:
            enabled: true
            spec:
              initialDelaySeconds: 10
              httpGet:
                path: /api/health
                port: 3000

    statefulset:
      volumeClaimTemplates:
        - name: data
          accessMode: ReadWriteOnce
          size: 2Gi
          storageClass: "karakeep"
          globalMounts:
            - path: /data

  chrome:
    containers:
      chrome:
        image:
          repository: gcr.io/zenika-hub/alpine-chrome
          tag: 123

        args:
          - --remote-debugging-address=0.0.0.0
          - --remote-debugging-port=9222
          - --headless
          - --hide-scrollbars
          - --disable-gpu
          - --disable-dev-shm-usage

        probes:
          liveness:
            enabled: true
            spec:
              httpGet:
                path: /
                port: 9222
          readiness:
            enabled: true
            spec:
              httpGet:
                path: /
                port: 9222

        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            add:
              - SYS_ADMIN
          readOnlyRootFilesystem: true
          runAsNonRoot: true
          runAsUser: 1000
          runAsGroup: 1000

        resources:
          requests:
            memory: 100Mi
            cpu: 500m
          limits:
            memory: 1Gi
            cpu: 1000m

service:
  karakeep:
    controller: karakeep
    ports:
      http:
        port: 3000
  chrome:
    controller: chrome
    ports:
      http:
        port: 9222

secrets:
  karakeep:
    enabled: true
    stringData:
      NEXTAUTH_SECRET: "{{ default (randAlphaNum 48) .Values.applicationSecretKey }}"
      OPENAI_API_KEY: "1234"
      OPENAI_BASE_URL: "http://10.69.1.101:9997/v1"
      INFERENCE_TEXT_MODEL: "gemma-3-it"
      INFERENCE_IMAGE_MODEL: "gemma-3-it"
      EMBEDDING_TEXT_MODEL: "Qwen3-Embedding-0.6B"
      INFERENCE_CONTEXT_LENGTH: "4096"
      INFERENCE_JOB_TIMEOUT_SEC: "3600"
  meilesearch:
    enabled: true
    stringData:
      MEILI_MASTER_KEY: "{{ default (randAlphaNum 30) .Values.meilisearchMasterKey }}"

ingress:
  karakeep:
    hosts:
      - host: "{{ .Values.applicationHost }}"
        paths:
          - path: /
            pathType: Prefix
            service:
              identifier: karakeep
              port: http

persistence:
  chrome-tmp:
    type: emptyDir
    advancedMounts:
      chrome:
        chrome:
          - path: /tmp
            readonly: false

meilisearch:
  image:
    repository: getmeili/meilisearch
    tag: v1.11.1
  auth:
    existingMasterKeySecret: "{{ .Release.Name }}-meilesearch"
  environment:
    MEILI_ENV: production
    MEILI_NO_ANALYTICS: "true"
  persistence:
    enabled: true
    size: 1Gi
    storageClass: "karakeep"
